syntax = "proto3";

package world;

import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/projectqai/proto/go";

// ---------------------------------------

message Entity {
  string id = 1;
  optional string label = 2;

  optional ControllerRef controller = 3;
  optional Lifetime lifetime = 4;
  optional Priority priority = 5;
  reserved 6;
  reserved 7;
  reserved 8;
  reserved 9;
  reserved 10;

  optional GeoSpatialComponent geo = 11;
  optional SymbolComponent symbol = 12;
  optional CameraComponent camera = 15;

  optional DetectionComponent detection = 16;
  optional BearingComponent bearing = 17;
  optional LocationUncertaintyComponent locationUncertainty = 20;
  optional TrackComponent track = 21;
  optional LocatorComponent locator = 22;
  optional TaskableComponent taskable = 23;
  optional KinematicsComponent kinematics = 24;
  optional GeoShapeComponent shape = 25;
  optional ClassificationComponent classification = 26;

  optional OrientationComponent orientation = 30;
  optional ConfigurationComponent config = 51;
}

message ControllerRef {
  string id = 1;
  string name = 2;
}

message Lifetime {
  optional google.protobuf.Timestamp from = 1;
  optional google.protobuf.Timestamp until = 2;
}

enum Priority {
  PriorityUnspecified = 0;

  // ROUTINE: Normal day-to-day traffic.
  // May be delayed or colescated into a later update when bandwidth is constrained
  PriorityRoutine = 1;

  // IMMEDIATE: Delay would negatively affect the mission
  // Sent before lower precedence messages
  PriorityImmediate = 2;

  // FLASH: Extreme urgency
  // Sent before lower precedence messages and without respecting mission bandwidth/signal limits
  // Highly visible flare, misuse can jeopardize missions
  PriorityFlash = 3;
}

message GeoSpatialComponent {
  double longitude = 1;
  double latitude = 2;

  // height above ellipsoid (WGS84) in meters
  optional double altitude = 3;

  optional CovarianceMatrix covariance = 4;
}

message SymbolComponent {
  string milStd2525C = 1;
}

enum CameraProtocol {
  CameraProtocolUnspecified = 0;
  CameraProtocolWebrtc = 1;
  CameraProtocolHls = 2;
  CameraProtocolMjpeg = 3;
  CameraProtocolImage = 4;
}

message Camera {
  string label = 1;
  string url = 2;
  CameraProtocol protocol = 3;
}

message CameraComponent {
  repeated Camera cameras = 1;
}

message DetectionComponent {
  optional string detectorEntityId = 1;
  optional string classification = 2;
  optional google.protobuf.Timestamp lastMeasured = 3;
}

message BearingComponent {
  optional double azimuth = 1;
  optional double elevation = 2;
}

message Quaternion {
  double x = 1;
  double y = 2;
  double z = 3;
  double w = 4;
}

message CovarianceMatrix {
  optional double mxx = 1;
  optional double mxy = 2;
  optional double mxz = 3;
  optional double myy = 4;
  optional double myz = 5;
  optional double mzz = 6;
}

message OrientationComponent {
  optional Quaternion orientation = 1;
  optional CovarianceMatrix covariance = 2;
}

// DEPRECATED: CovarianceMatrix is now included in every message
message LocationUncertaintyComponent {
  option deprecated = true;
  optional CovarianceMatrix positionEnuCov = 1;
  optional CovarianceMatrix velocityEnuCov = 2;
}

message TrackComponent {}

message LocatorComponent {
  string locatedEntityId = 1;
}

message TaskableContext {
  optional string entityId = 1;
}

message TaskableAssignee {
  optional string entityId = 1;
}

message TaskableComponent {
  optional string reserved = 1;
  optional string label = 2;
  repeated TaskableContext context = 3;
  repeated TaskableAssignee assignee = 4;
}

message KinematicsEnu {
  // Velocity components in the local East-North-Up (ENU) coordinate frame.
  // The ENU frame is a right-handed Cartesian coordinate system with origin
  // at the entity's position (GeoSpatialComponent), where:
  // - East axis: tangent to the latitude line, pointing eastward
  // - North axis: tangent to the longitude line, pointing northward
  // - Up axis: perpendicular to the WGS84 ellipsoid, pointing away from Earth center
  //
  // Note: This is NOT a body frame - the axes do not rotate with the entity's
  // heading/attitude. Velocities are expressed relative to the Earth's surface.
  // All units are in meters per second (m/s).
  optional double east = 1; // m/s
  optional double north = 2; // m/s
  optional double up = 3; // m/s
  optional CovarianceMatrix covariance = 4;
}

message KinematicsComponent {
  // Velocity in local ENU frame (see KinematicsEnu for frame definition)
  optional KinematicsEnu velocityEnu = 1;
  // Acceleration in local ENU frame (m/sÂ²)
  optional KinematicsEnu accelerationEnu = 2;
}

message GeoShapeComponent {
  optional Geometry geometry = 1;
}

enum ClassificationIdentity {
  ClassificationIdentityInvalid = 0;
  ClassificationIdentityPending = 1; // P
  ClassificationIdentityUnknown = 2; // U
  ClassificationIdentityFriend = 3; // F
  ClassificationIdentityNeutral = 4; // N
  ClassificationIdentityHostile = 5; // H
  ClassificationIdentitySuspect = 6; // S
}

enum ClassificationBattleDimension {
  ClassificationBattleDimensionInvalid = 0;
  ClassificationBattleDimensionUnknown = 1; // Z
  ClassificationBattleDimensionSpace = 2; // P
  ClassificationBattleDimensionAir = 3; // A
  ClassificationBattleDimensionGround = 4; // G
  ClassificationBattleDimensionSeaSurface = 5; // S
  ClassificationBattleDimensionSubsurface = 6; // U
}

message ClassificationComponent {
  optional ClassificationBattleDimension dimension = 1;
  optional ClassificationIdentity identity = 2;
}

message ConfigurationComponent {
  string controller = 1;
  string key = 2;
  google.protobuf.Struct value = 3;
}

// ---------------------------------------------

// a 2.5D point on the projected flat surface in WGS84
message PlanarPoint {
  double longitude = 1;
  double latitude = 2;

  // height above ellipsoid (WGS84) in meters
  optional double altitude = 3;
}

// a path with zero area on the projected flat surface
// a ring is considered to be closed when the first and last points are identical
message PlanarRing {
  repeated PlanarPoint points = 1;
}

/// An area enclosed by a ring, with optional holes.
/// All rings must be closed (first point = last point)
message PlanarPolygon {
  PlanarRing outer = 1;
  repeated PlanarRing holes = 2;
}

// 2.5D geometry in WGS 84
message PlanarGeometry {
  oneof plane {
    PlanarPoint point = 1;
    PlanarRing line = 2;
    PlanarPolygon polygon = 3;
  }
}

message Geometry {
  bytes wkb = 1 [deprecated = true];
  PlanarGeometry planar = 2;
}

// ---------------------------------------------

message EntityFilter {
  optional string id = 1; // exact match on entity id
  optional string label = 2; // exact match on entity label
  optional GeoFilter geo = 3; // entity geo intersects with geometry/bounds
  optional TaskableFilter taskable = 4;
  repeated uint32 component = 5; // entity must have ALL these components

  optional ConfigurationFilter config = 51;

  repeated EntityFilter or = 100; // matches if ANY child filter matches
  EntityFilter not = 101; // matches if child filter does NOT match
}

message TaskableFilter {
  optional TaskableContext context = 1;
  optional TaskableAssignee assignee = 2;
}

message GeoFilter {
  oneof geo {
    Geometry geometry = 1; // intersects with this geometry (bounding box check)
    string geoEntityId = 2; // intersects with another entity's geo bounds
  }
}

message ConfigurationFilter {
  optional string controller = 1;
  optional string key = 2;
}

message WatchBehavior {
  // Maximum non-flash messages per second this consumer can handle (0 = unlimited)
  optional uint64 max_messages_per_second = 1;

  // Only deliver messages at or above this priority level
  // Default (unset or PriorityReserved0) = deliver all priorities
  optional Priority min_priority = 3;

  // Re-stream all matching entities at this interval in milliseconds, even if unchanged.
  // For consumers that dont understand lifetimes and require fixed interval updates
  // 0 or unset = only stream actual changes
  // values lower than 1000 might be capped to 1s
  optional uint32 keepalive_interval_ms = 4;
}

message ListEntitiesRequest {
  reserved 1; //deprecated
  EntityFilter filter = 2;

  optional WatchBehavior behaviour = 4;
}

message ListEntitiesResponse {
  repeated Entity entities = 1;
}

message EntityChangeRequest {
  repeated Entity changes = 1;
}

message EntityChangeResponse {
  bool accepted = 1;
  string debug = 2;
}

enum EntityChange {
  EntityChangeInvalid = 0;
  EntityChangeUpdated = 1;
  EntityChangeExpired = 2;
  EntityChangeUnobserved = 3;
}

message EntityChangeEvent {
  Entity entity = 1;
  EntityChange t = 2;
}

message EntityChangeBatch {
  repeated EntityChangeEvent events = 1;
}

message GetEntityRequest {
  string id = 1;
}

message GetEntityResponse {
  Entity entity = 1;
}

message ObserverRequest {}

message ObserverState {
  Geometry geo = 1;
  optional google.protobuf.Timestamp viewHistory = 2;
}

message RunTaskRequest {
  string entityId = 1;
}

enum TaskStatus {
  TaskStatusInvalid = 0;
  TaskStatusRunning = 1;
  TaskStatusCompleted = 2;
  TaskStatusFailed = 3;
}

message RunTaskResponse {
  string executionId = 1;
  TaskStatus status = 2;
  optional string humanReadableReason = 3;
}

// interact with the world model
service WorldService {
  // list entities present in the world once
  rpc ListEntities(ListEntitiesRequest) returns (ListEntitiesResponse);

  // request every detail about one entity
  rpc GetEntity(GetEntityRequest) returns (GetEntityResponse);

  // continously monitor entities present in the world. this is used by downstream C2.
  rpc WatchEntities(ListEntitiesRequest) returns (stream EntityChangeEvent);

  // create or update an entity. used by capabilities
  rpc Push(EntityChangeRequest) returns (EntityChangeResponse);

  // create an instance of a specific task entity
  rpc RunTask(RunTaskRequest) returns (RunTaskResponse);
}
