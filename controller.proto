syntax = "proto3";

package world;

import "world.proto";

option go_package = "github.com/projectqai/proto/go";

message ControllerReconciliationRequest {
  string controller = 1;
}

enum ControllerDeviceConfigurationEventType {
  ControllerDeviceConfigurationEventNew = 0;
  ControllerDeviceConfigurationEventChanged = 1;
  ControllerDeviceConfigurationEventRemoved = 2;
}

// An entity with Config on this controller was added, changed, or removed.
message ControllerDeviceConfigurationEvent {
  ControllerDeviceConfigurationEventType t = 1;
  Entity config = 2;
}

message ControllerReconciliationEvent {
  oneof event {
    ControllerDeviceConfigurationEvent config = 2;
  }
}

// API for controllers to receive work from the engine.
//
// The engine watches for entities that have:
//   - Controller.Id == the requested controller name
//   - Config != nil
//   - Controller.Node == local node
//
// and streams them as ControllerDeviceConfigurationEvent messages.
//
// ## Event sequences
//
//   Stream starts:
//     New(entity) for each matching entity
//
//   Entity gains Config for this controller:
//     New(entity)
//
//   Entity Config value updated:
//     Changed(entity)
//
//   Entity removed or no longer matches:
//     Removed(entity)

message RestartConnectorRequest {
  string controller = 1;
  string entity_id = 2;
}
message RestartConnectorResponse {}

service ControllerService {
  rpc Reconcile(ControllerReconciliationRequest) returns (stream ControllerReconciliationEvent);
  rpc RestartConnector(RestartConnectorRequest) returns (RestartConnectorResponse);
}
